<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Sst-commit-watch] r663 - trunk/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/sst-commit-watch/2006-October/index.html" >
   <LINK REL="made" HREF="mailto:sst-commit-watch%40lists.berlios.de?Subject=Re%3A%20%5BSst-commit-watch%5D%20r663%20-%20trunk/src&In-Reply-To=%3C200610041619.k94GJa3c009063%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000129.html">
   <LINK REL="Next"  HREF="000131.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Sst-commit-watch] r663 - trunk/src</H1>
    <B>esr at BerliOS</B> 
    <A HREF="mailto:sst-commit-watch%40lists.berlios.de?Subject=Re%3A%20%5BSst-commit-watch%5D%20r663%20-%20trunk/src&In-Reply-To=%3C200610041619.k94GJa3c009063%40sheep.berlios.de%3E"
       TITLE="[Sst-commit-watch] r663 - trunk/src">esr at mail.berlios.de
       </A><BR>
    <I>Wed Oct  4 18:19:36 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000129.html">[Sst-commit-watch] r662 - trunk/src
</A></li>
        <LI>Next message: <A HREF="000131.html">[Sst-commit-watch] r664 - trunk/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#130">[ date ]</a>
              <a href="thread.html#130">[ thread ]</a>
              <a href="subject.html#130">[ subject ]</a>
              <a href="author.html#130">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: esr
Date: 2006-10-04 18:19:35 +0200 (Wed, 04 Oct 2006)
New Revision: 663

Modified:
   trunk/src/sst.py
Log:
Code from moving.c incorporated into Python translation.


Modified: trunk/src/sst.py
===================================================================
--- trunk/src/sst.py	2006-10-04 14:54:15 UTC (rev 662)
+++ trunk/src/sst.py	2006-10-04 16:19:35 UTC (rev 663)
@@ -1333,7 +1333,7 @@
     if shoved:
 	game.quad[w.x][w.y]=IHDOT
 	game.quad[jw.x][jw.y]=iquad
-	prout(_(&quot; displaced by blast to %s &quot;), cramlc(sector, jw))
+	prout(_(&quot; displaced by blast to Sector %s &quot;) % jw)
 	for ll in range(1, game.nenhere+1):
 	    game.kdist[ll] = game.kavgd[ll] = distance(game.sector,game.ks[ll])
 	sortklings()
@@ -1525,7 +1525,7 @@
 	    proutn(_(&quot;down &quot;))
 	else:
 	    proutn(_(&quot;damaged, &quot;))
-    prout(_(&quot;%d%%,   torpedoes left %d&quot;), percent, game.torps)
+    prout(_(&quot;%d%%,   torpedoes left %d&quot;) % (percent, game.torps))
     # Check if anyone was hurt 
     if hitmax &gt;= 200 or hittot &gt;= 500:
 	icas= hittot*Rand()*0.015
@@ -1645,7 +1645,7 @@
 	    huh()
 	    return
 	elif key == IHEOL:
-	    prout(_(&quot;%d torpedoes left.&quot;), game.torps)
+	    prout(_(&quot;%d torpedoes left.&quot;) % game.torps)
 	    proutn(_(&quot;Number of torpedoes to fire- &quot;))
 	    key = scan()
 	else: # key == IHREAL  {
@@ -1690,7 +1690,7 @@
     if i == 1 and key == IHEOL:
 	# prompt for each one 
 	for i in range(1, n+1):
-	    proutn(_(&quot;Target sector for torpedo number %d- &quot;), i)
+	    proutn(_(&quot;Target sector for torpedo number %d- &quot;) % i)
 	    key = scan()
 	    if key != IHREAL:
 		huh()
@@ -1715,7 +1715,7 @@
 	    # misfire! 
 	    r = (Rand()+1.2) * r
 	    if n&gt;1:
-		prouts(_(&quot;***TORPEDO NUMBER %d MISFIRES&quot;), i)
+		prouts(_(&quot;***TORPEDO NUMBER %d MISFIRES&quot;) % i)
 	    else:
 		prouts(_(&quot;***TORPEDO MISFIRES.&quot;))
 	    skip(1)
@@ -1769,7 +1769,7 @@
     if icas:
 	skip(1)
 	prout(_(&quot;McCoy to bridge- \&quot;Severe radiation burns, Jim.&quot;))
-	prout(_(&quot;  %d casualties so far.\&quot;&quot;), icas)
+	prout(_(&quot;  %d casualties so far.\&quot;&quot;) % icas)
 	game.casual += icas
 	game.state.crew -= icas
     skip(1)
@@ -1820,8 +1820,7 @@
 	else: # decide whether or not to emasculate klingon 
 	    if kpow &gt; 0 and Rand() &gt;= 0.9 and \
 		kpow &lt;= ((0.4 + 0.4*Rand())*kpini):
-		prout(_(&quot;***Mr. Spock-  \&quot;Captain, the vessel at %s&quot;),
-		      cramlc(sector, w))
+		prout(_(&quot;***Mr. Spock-  \&quot;Captain, the vessel at Sector %s&quot;), w)
 		prout(_(&quot;   has just lost its firepower.\&quot;&quot;))
 		game.kpower[kk] = -kpow
         kk += 1
@@ -1910,8 +1909,7 @@
 	    no = True
 	    key = scan()
 	if key != IHREAL and game.nenhere != 0:
-	    prout(_(&quot;Phasers locked on target. Energy available: %.2f&quot;),
-		  avail)
+	    prout(_(&quot;Phasers locked on target. Energy available: %.2f&quot;)%avail)
 	irec=0
         while True:
 	    chew()
@@ -1919,7 +1917,7 @@
 		for i in range(1, game.nenhere+1):
 		    irec += math.fabs(game.kpower[i])/(PHASEFAC*math.pow(0.90,game.kdist[i]))*(1.01+0.05*Rand()) + 1.0
 	    kz=1
-	    proutn(_(&quot;%d units required. &quot;), irec)
+	    proutn(_(&quot;%d units required. &quot;) % irec)
 	    chew()
 	    proutn(_(&quot;Units to fire= &quot;))
 	    key = scan()
@@ -1973,7 +1971,7 @@
 		    proutn(_(&quot;excess &quot;))
 		prout(_(&quot;phaser energy.&quot;))
 	    else:
-		prout(_(&quot;%d expended on empty space.&quot;), int(extra))
+		prout(_(&quot;%d expended on empty space.&quot;) % int(extra))
     elif automode == &quot;FORCEMAN&quot;:
 	chew()
 	key = IHEOL
@@ -1993,7 +1991,7 @@
 	    aim = game.ks[k]
 	    ienm = game.quad[aim.x][aim.y]
 	    if msgflag:
-		proutn(_(&quot;Energy available= %.2f&quot;) % avail-0.006)
+		proutn(_(&quot;Energy available= %.2f&quot;) % (avail-0.006))
 		skip(1)
 		msgflag = False
 		rpow = 0.0
@@ -2013,7 +2011,7 @@
 		kz = k
 		proutn(&quot;(&quot;)
 		if not damaged(DCOMPTR):
-		    proutn(&quot;%d&quot;, irec)
+		    proutn(&quot;%d&quot; % irec)
 		else:
 		    proutn(&quot;??&quot;)
 		proutn(&quot;)  &quot;)
@@ -2249,7 +2247,7 @@
 	    if game.future[l].date &lt; datemin:
 		evcode = l
 		if idebug:
-		    prout(&quot;== Event %d fires&quot; % (evcode))
+		    prout(&quot;== Event %d fires&quot; % evcode)
 		datemin = game.future[l].date
 	xtime = datemin-game.state.date
 	game.state.date = datemin
@@ -2370,7 +2368,7 @@
 	    skip(1)
 	    proutn(_(&quot;Lt. Uhura-  \&quot;Captain, the starbase in Quadrant %s&quot;) % game.battle)
 	    prout(_(&quot;   reports that it is under attack and that it can&quot;))
-	    proutn(_(&quot;   hold out only until stardate %d&quot; % (int(scheduled(FCDBAS)))))
+	    proutn(_(&quot;   hold out only until stardate %d&quot;) % (int(scheduled(FCDBAS))))
             prout(&quot;.\&quot;&quot;)
 	    if cancelrest():
                 return
@@ -2470,8 +2468,8 @@
 
 	    # tell the captain about it if we can 
 	    if not damaged(DRADIO) or game.condition == &quot;docked&quot;:
-		prout(_(&quot;Uhura- Captain, %s in Quadrant %s reports it is under attack&quot; \
-                        % (systnames[q.planet], `w`)))
+		prout(_(&quot;Uhura- Captain, %s in Quadrant %s reports it is under attack&quot;) \
+                        % (q.planet, `w`))
 		prout(_(&quot;by a Klingon invasion fleet.&quot;))
 		if cancelrest():
 		    return
@@ -2490,9 +2488,9 @@
 
 	    # report the disaster if we can 
 	    if not damaged(DRADIO) or game.condition == &quot;docked&quot;:
-		prout(_(&quot;Uhura- We've lost contact with starsystem %s&quot; % \
-                        systnames[q.planet]))
-		prout(_(&quot;in Quadrant %s.\n&quot; % ev.quadrant))
+		prout(_(&quot;Uhura- We've lost contact with starsystem %s&quot;) % \
+                        q.planet)
+		prout(_(&quot;in Quadrant %s.\n&quot;) % ev.quadrant)
 	elif evcode == FREPRO:		# Klingon reproduces 
 	    # If we ever switch to a real event queue, we'll need to
 	    # explicitly retrieve and restore the x and y.
@@ -2535,13 +2533,12 @@
 	    if not damaged(DRADIO) or game.condition == &quot;docked&quot;:
 		if same(game.quadrant, w):
 		    prout(_(&quot;Spock- sensors indicate the Klingons have&quot;))
-		    prout(_(&quot;launched a warship from %s.&quot; \
-                            % systnames[q.planet]))
+		    prout(_(&quot;launched a warship from %s.&quot;) % q.planet)
 		else:
 		    prout(_(&quot;Uhura- Starfleet reports increased Klingon activity&quot;))
 		    if q.planet != NOPLANET:
-			proutn(_(&quot;near %s&quot; % systnames[q.planet]))
-		    prout(_(&quot;in %s.\n&quot; % cramlc(quadrant, w)))
+			proutn(_(&quot;near %s&quot;) % q.planet)
+		    prout(_(&quot;in Quadrant %s.&quot;) % w)
 				
 def wait():
     # wait on events 
@@ -2570,7 +2567,7 @@
 	if delay &lt;= 0:
 	    game.resting = False
 	if not game.resting:
-	    prout(_(&quot;%d stardates left.&quot; % int(game.state.remtime)))
+	    prout(_(&quot;%d stardates left.&quot;) % int(game.state.remtime))
 	    return
 	temp = game.optime = delay
 	if game.nenhere:
@@ -2792,8 +2789,8 @@
 	# it isn't here, or we just entered (treat as enroute) 
 	if not damaged(DRADIO) or game.condition == &quot;docked&quot;:
 	    skip(1)
-	    prout(_(&quot;Message from Starfleet Command       Stardate %.2f&quot; % game.state.date))
-	    prout(_(&quot;     Supernova in Quadrant %s; caution advised.&quot; % nq))
+	    prout(_(&quot;Message from Starfleet Command       Stardate %.2f&quot;) % game.state.date)
+	    prout(_(&quot;     Supernova in Quadrant %s; caution advised.&quot;) % nq)
     else:
 	ns = coord()
 	# we are in the quadrant! 
@@ -2810,7 +2807,7 @@
 	skip(1)
 	prouts(_(&quot;***RED ALERT!  RED ALERT!&quot;))
 	skip(1)
-	prout(_(&quot;***Incipient supernova detected at Sector %s&quot; % ns))
+	prout(_(&quot;***Incipient supernova detected at Sector %s&quot;) % ns)
 	if square(ns.x-game.sector.x) + square(ns.y-game.sector.y) &lt;= 2.1:
 	    proutn(_(&quot;Emergency override attempts t&quot;))
 	    prouts(&quot;***************&quot;)
@@ -2870,7 +2867,7 @@
 	skip(2)
 	if not induced:
 	    prout(_(&quot;Lucky you!&quot;))
-	proutn(_(&quot;A supernova in %s has just destroyed the last Klingons.&quot; % nq))
+	proutn(_(&quot;A supernova in %s has just destroyed the last Klingons.&quot;) % nq)
 	finish(FWON)
 	return
     # if some Klingons remain, continue or die in supernova 
@@ -2964,7 +2961,7 @@
     igotit = False
     game.alldone = True
     skip(3)
-    prout(_(&quot;It is stardate %.1f.&quot; % (game.state.date)))
+    prout(_(&quot;It is stardate %.1f.&quot;) % game.state.date)
     skip(1)
     if ifin == FWON: # Game has been won
 	if game.state.nromrem != 0:
@@ -3198,47 +3195,47 @@
     skip(2)
     prout(_(&quot;Your score --&quot;))
     if game.inrom - game.state.nromrem:
-	prout(_(&quot;%6d Romulans destroyed                 %5d&quot; %
-	      (game.inrom - game.state.nromrem, 20*(game.inrom - game.state.nromrem))))
+	prout(_(&quot;%6d Romulans destroyed                 %5d&quot;) %
+	      (game.inrom - game.state.nromrem, 20*(game.inrom - game.state.nromrem)))
     if game.state.nromrem:
-	prout(_(&quot;%6d Romulans captured                  %5d&quot; %
-	      (game.state.nromrem, game.state.nromrem)))
+	prout(_(&quot;%6d Romulans captured                  %5d&quot;) %
+	      (game.state.nromrem, game.state.nromrem))
     if game.inkling - game.state.remkl:
-	prout(_(&quot;%6d ordinary Klingons destroyed        %5d&quot; %
-	      (game.inkling - game.state.remkl, 10*(game.inkling - game.state.remkl))))
+	prout(_(&quot;%6d ordinary Klingons destroyed        %5d&quot;) %
+	      (game.inkling - game.state.remkl, 10*(game.inkling - game.state.remkl)))
     if game.incom - game.state.remcom:
-	prout(_(&quot;%6d Klingon commanders destroyed       %5d&quot; %
-	      (game.incom - game.state.remcom, 50*(game.incom - game.state.remcom))))
+	prout(_(&quot;%6d Klingon commanders destroyed       %5d&quot;) %
+	      (game.incom - game.state.remcom, 50*(game.incom - game.state.remcom)))
     if game.inscom - game.state.nscrem:
-	prout(_(&quot;%6d Super-Commander destroyed          %5d&quot; %
-	      (game.inscom - game.state.nscrem, 200*(game.inscom - game.state.nscrem))))
+	prout(_(&quot;%6d Super-Commander destroyed          %5d&quot;) %
+	      (game.inscom - game.state.nscrem, 200*(game.inscom - game.state.nscrem)))
     if ithperd:
-	prout(_(&quot;%6.2f Klingons per stardate              %5d&quot; %
-	      (perdate, ithperd)))
+	prout(_(&quot;%6.2f Klingons per stardate              %5d&quot;) %
+	      (perdate, ithperd))
     if game.state.starkl:
-	prout(_(&quot;%6d stars destroyed by your action     %5d&quot; %
-	      (game.state.starkl, -5*game.state.starkl)))
+	prout(_(&quot;%6d stars destroyed by your action     %5d&quot;) %
+	      (game.state.starkl, -5*game.state.starkl))
     if game.state.nplankl:
-	prout(_(&quot;%6d planets destroyed by your action   %5d&quot; %
-	      (game.state.nplankl, -10*game.state.nplankl)))
+	prout(_(&quot;%6d planets destroyed by your action   %5d&quot;) %
+	      (game.state.nplankl, -10*game.state.nplankl))
     if (game.options &amp; OPTION_WORLDS) and game.state.nworldkl:
-	prout(_(&quot;%6d inhabited planets destroyed by your action   %5d&quot; %
-	      (game.state.nplankl, -300*game.state.nworldkl)))
+	prout(_(&quot;%6d inhabited planets destroyed by your action   %5d&quot;) %
+	      (game.state.nplankl, -300*game.state.nworldkl))
     if game.state.basekl:
-	prout(_(&quot;%6d bases destroyed by your action     %5d&quot; %
-	      (game.state.basekl, -100*game.state.basekl)))
+	prout(_(&quot;%6d bases destroyed by your action     %5d&quot;) %
+	      (game.state.basekl, -100*game.state.basekl))
     if game.nhelp:
-	prout(_(&quot;%6d calls for help from starbase       %5d&quot; %
-	      (game.nhelp, -45*game.nhelp)))
+	prout(_(&quot;%6d calls for help from starbase       %5d&quot;) %
+	      (game.nhelp, -45*game.nhelp))
     if game.casual:
-	prout(_(&quot;%6d casualties incurred                %5d&quot; %
-	      (game.casual, -game.casual)))
+	prout(_(&quot;%6d casualties incurred                %5d&quot;) %
+	      (game.casual, -game.casual))
     if game.abandoned:
-	prout(_(&quot;%6d crew abandoned in space            %5d&quot; %
-	      (game.abandoned, -3*game.abandoned)))
+	prout(_(&quot;%6d crew abandoned in space            %5d&quot;) %
+	      (game.abandoned, -3*game.abandoned))
     if klship:
-	prout(_(&quot;%6d ship(s) lost or destroyed          %5d&quot; %
-	      (klship, -100*klship)))
+	prout(_(&quot;%6d ship(s) lost or destroyed          %5d&quot;) %
+	      (klship, -100*klship))
     if not game.alive:
 	prout(_(&quot;Penalty for getting yourself killed        -200&quot;))
     if game.gamewon:
@@ -3248,9 +3245,9 @@
 	elif game.skill ==  SKILL_GOOD: 	proutn(_(&quot;Good game    &quot;))
 	elif game.skill ==  SKILL_EXPERT:	proutn(_(&quot;Expert game  &quot;))
 	elif game.skill ==  SKILL_EMERITUS:	proutn(_(&quot;Emeritus game&quot;))
-	prout(&quot;           %5d&quot; % (iwon))
+	prout(&quot;           %5d&quot; % iwon)
     skip(1)
-    prout(_(&quot;TOTAL SCORE                               %5d&quot; % iscore))
+    prout(_(&quot;TOTAL SCORE                               %5d&quot;) % iscore)
 
 def plaque():
     # emit winner's commemmorative plaque 
@@ -3305,10 +3302,10 @@
     else:
         fp.write(_(&quot; Cheat level\n\n&quot;))
     timestring = ctime()
-    fp.write(_(&quot;                                                 This day of %.6s %.4s, %.8s\n\n&quot; %
-                    (timestring+4, timestring+20, timestring+11)))
-    fp.write(_(&quot;                                                        Your score:  %d\n\n&quot; % iscore))
-    fp.write(_(&quot;                                                    Klingons per stardate:  %.2f\n&quot; % perdate))
+    fp.write(_(&quot;                                                 This day of %.6s %.4s, %.8s\n\n&quot;) %
+                    (timestring+4, timestring+20, timestring+11))
+    fp.write(_(&quot;                                                        Your score:  %d\n\n&quot;) % iscore)
+    fp.write(_(&quot;                                                    Klingons per stardate:  %.2f\n&quot;) % perdate)
     fp.close()
 
 # Code from io.c begins here
@@ -3603,7 +3600,7 @@
 	if l == 1:
 	    if n != 1:
 		skip(1)
-		proutn(_(&quot;Track for torpedo number %d-  &quot; % i))
+		proutn(_(&quot;Track for torpedo number %d-  &quot;) % i)
 	    else:
 		skip(1)
 		proutn(_(&quot;Torpedo track- &quot;))
@@ -3654,3 +3651,1002 @@
     skip(1)
     if game.options &amp; OPTION_CURSES:
 	setwnd(report_window)
+
+# Code from moving.c begins here
+
+def imove(novapush):
+    # movement execution for warp, impulse, supernova, and tractor-beam events 
+    w = coord(); final = coord()
+    trbeam = False
+
+    def no_quad_change():
+        # No quadrant change -- compute new avg enemy distances 
+        game.quad[game.sector.x][game.sector.y] = game.ship
+        if game.nenhere:
+            for m in range(1, game.nenhere+1):
+                finald = distance(w, game.ks[m])
+                game.kavgd[m] = 0.5 * (finald+game.kdist[m])
+                game.kdist[m] = finald
+            sortklings()
+            if not game.state.galaxy[game.quadrant.x][game.quadrant.y].supernova:
+                attack(False)
+            for m in range(1, game.nenhere+1):
+                game.kavgd[m] = game.kdist[m]
+        newcnd()
+        drawmaps(0)
+        setwnd(message_window)
+
+    w.x = w.y = 0
+    if game.inorbit:
+	prout(_(&quot;Helmsman Sulu- \&quot;Leaving standard orbit.\&quot;&quot;))
+	game.inorbit = False
+
+    angle = ((15.0 - game.direc) * 0.5235988)
+    deltax = -math.sin(angle)
+    deltay = math.cos(angle)
+    if math.fabs(deltax) &gt; math.fabs(deltay):
+	bigger = math.fabs(deltax)
+    else:
+	bigger = math.fabs(deltay)
+		
+    deltay /= bigger
+    deltax /= bigger
+
+    # If tractor beam is to occur, don't move full distance 
+    if game.state.date+game.optime &gt;= scheduled(FTBEAM):
+	trbeam = True
+	game.condition = &quot;red&quot;
+	game.dist = game.dist*(scheduled(FTBEAM)-game.state.date)/game.optime + 0.1
+	game.optime = scheduled(FTBEAM) - game.state.date + 1e-5
+    # Move within the quadrant 
+    game.quad[game.sector.x][game.sector.y] = IHDOT
+    x = game.sector.x
+    y = game.sector.y
+    n = 10.0*game.dist*bigger+0.5
+
+    if n &gt; 0:
+	for m in range(1, n+1):
+            x += deltax
+            y += deltay
+	    w.x = x + 0.5
+	    w.y = y + 0.5
+	    if not VALID_SECTOR(w.x, w.y):
+		# Leaving quadrant -- allow final enemy attack 
+		# Don't do it if being pushed by Nova 
+		if game.nenhere != 0 and not novapush:
+		    newcnd()
+		    for m in range(1, game.nenhere+1):
+			finald = distance(w, game.ks[m])
+			game.kavgd[m] = 0.5 * (finald + game.kdist[m])
+		    #
+		    # Stas Sergeev added the condition
+		    # that attacks only happen if Klingons
+		    # are present and your skill is good.
+		    # 
+		    if game.skill &gt; SKILL_GOOD and game.klhere &gt; 0 and not game.state.galaxy[game.quadrant.x][game.quadrant.y].supernova:
+			attack(False)
+		    if game.alldone:
+			return
+		# compute final position -- new quadrant and sector 
+		x = QUADSIZE*(game.quadrant.x-1)+game.sector.x
+		y = QUADSIZE*(game.quadrant.y-1)+game.sector.y
+		w.x = x+10.0*game.dist*bigger*deltax+0.5
+		w.y = y+10.0*game.dist*bigger*deltay+0.5
+		# check for edge of galaxy 
+		kinks = 0
+                while True:
+		    kink = 0
+		    if w.x &lt;= 0:
+			w.x = -w.x + 1
+			kink = 1
+		    if w.y &lt;= 0:
+			w.y = -w.y + 1
+			kink = 1
+		    if w.x &gt; GALSIZE*QUADSIZE:
+			w.x = (GALSIZE*QUADSIZE*2)+1 - w.x
+			kink = 1
+		    if w.y &gt; GALSIZE*QUADSIZE:
+			w.y = (GALSIZE*QUADSIZE*2)+1 - w.y
+			kink = 1
+		    if kink:
+			kinks = 1
+		if not kink:
+                    break
+
+		if kinks:
+		    game.nkinks += 1
+		    if game.nkinks == 3:
+			# Three strikes -- you're out! 
+			finish(FNEG3)
+			return
+		    skip(1)
+		    prout(_(&quot;YOU HAVE ATTEMPTED TO CROSS THE NEGATIVE ENERGY BARRIER&quot;))
+		    prout(_(&quot;AT THE EDGE OF THE GALAXY.  THE THIRD TIME YOU TRY THIS,&quot;))
+		    prout(_(&quot;YOU WILL BE DESTROYED.&quot;))
+		# Compute final position in new quadrant 
+		if trbeam: # Don't bother if we are to be beamed 
+		    return
+		game.quadrant.x = (w.x+(QUADSIZE-1))/QUADSIZE
+		game.quadrant.y = (w.y+(QUADSIZE-1))/QUADSIZE
+		game.sector.x = w.x - QUADSIZE*(game.quadrant.x-1)
+		game.sector.y = w.y - QUADSIZE*(game.quadrant.y-1)
+		skip(1)
+		prout(_(&quot;Entering Quadrant %s.&quot;) % game.quadrant)
+		game.quad[game.sector.x][game.sector.y] = game.ship
+		newqad(False)
+		if game.skill&gt;SKILL_NOVICE:
+		    attack(False)  
+		return
+	    iquad = game.quad[w.x][w.y]
+	    if iquad != IHDOT:
+		# object encountered in flight path 
+		stopegy = 50.0*game.dist/game.optime
+		game.dist = distance(game.sector, w) / (QUADSIZE * 1.0)
+                if iquad in (IHT. IHK, OHC, IHS, IHR, IHQUEST):
+		    game.sector = w
+		    ram(False, iquad, game.sector)
+		    final = game.sector
+		elif iquad == IHBLANK:
+		    skip(1)
+		    prouts(_(&quot;***RED ALERT!  RED ALERT!&quot;))
+		    skip(1)
+		    proutn(&quot;***&quot;)
+		    crmshp()
+		    proutn(_(&quot; pulled into black hole at Sector %s&quot;) % w)
+		    #
+		    # Getting pulled into a black hole was certain
+		    # death in Almy's original.  Stas Sergeev added a
+		    # possibility that you'll get timewarped instead.
+		    # 
+		    n=0
+		    for m in range(0, NDEVICES):
+			if game.damage[m]&gt;0: 
+			    n += 1
+		    probf=math.pow(1.4,(game.energy+game.shield)/5000.0-1.0)*math.pow(1.3,1.0/(n+1)-1.0)
+		    if (game.options &amp; OPTION_BLKHOLE) and Rand()&gt;probf: 
+			timwrp()
+		    else: 
+			finish(FHOLE)
+		    return
+		else:
+		    # something else 
+		    skip(1)
+		    crmshp()
+		    if iquad == IHWEB:
+			proutn(_(&quot; encounters Tholian web at %s;&quot;) % w)
+		    else:
+			proutn(_(&quot; blocked by object at %s;&quot;) % w)
+		    proutn(_(&quot;Emergency stop required &quot;))
+		    prout(_(&quot;%2d units of energy.&quot;) % int(stopegy))
+		    game.energy -= stopegy
+		    final.x = x-deltax+0.5
+		    final.y = y-deltay+0.5
+		    game.sector = final
+		    if game.energy &lt;= 0:
+			finish(FNRG)
+			return
+                # We're here!
+		no_quad_change()
+                return
+	game.dist = distance(game.sector, w) / (QUADSIZE * 1.0)
+	game.sector = w
+    final = game.sector
+    no_quad_change()
+    return
+
+def dock(verbose):
+    # dock our ship at a starbase 
+    chew()
+    if game.condition == &quot;docked&quot; and verbose:
+	prout(_(&quot;Already docked.&quot;))
+	return
+    if game.inorbit:
+	prout(_(&quot;You must first leave standard orbit.&quot;))
+	return
+    if not is_valid(game.base) or abs(game.sector.x-game.base.x) &gt; 1 or abs(game.sector.y-game.base.y) &gt; 1:
+	crmshp()
+	prout(_(&quot; not adjacent to base.&quot;))
+	return
+    game.condition = &quot;docked&quot;
+    if &quot;verbose&quot;:
+	prout(_(&quot;Docked.&quot;))
+    game.ididit = True
+    if game.energy &lt; game.inenrg:
+	game.energy = game.inenrg
+    game.shield = game.inshld
+    game.torps = game.intorps
+    game.lsupres = game.inlsr
+    game.state.crew = FULLCREW
+    if not damaged(DRADIO) and \
+	((is_scheduled(FCDBAS) or game.isatb == 1) and not game.iseenit):
+	# get attack report from base 
+	prout(_(&quot;Lt. Uhura- \&quot;Captain, an important message from the starbase:\&quot;&quot;))
+	attackreport(False)
+	game.iseenit = True
+
+# 
+# This program originally required input in terms of a (clock)
+# direction and distance. Somewhere in history, it was changed to
+# cartesian coordinates. So we need to convert.  Probably
+# &quot;manual&quot; input should still be done this way -- it's a real
+# pain if the computer isn't working! Manual mode is still confusing
+# because it involves giving x and y motions, yet the coordinates
+# are always displayed y - x, where +y is downward!
+# 
+
+def getcd(isprobe, akey):
+    # get course and distance 
+    irowq=game.quadrant.x; icolq=game.quadrant.y; key=0
+    navmode = &quot;unspecified&quot;
+    itemp = &quot;curt&quot;
+    incr = coord()
+    iprompt = False
+
+    # Get course direction and distance. If user types bad values, return
+    # with DIREC = -1.0.
+    game.direc = -1.0
+	
+    if game.landed and not isprobe:
+	prout(_(&quot;Dummy! You can't leave standard orbit until you&quot;))
+	proutn(_(&quot;are back aboard the ship.&quot;))
+	chew()
+	return
+    while navmode == &quot;unspecified&quot;:
+	if damaged(DNAVSYS):
+	    if isprobe:
+		prout(_(&quot;Computer damaged; manual navigation only&quot;))
+	    else:
+		prout(_(&quot;Computer damaged; manual movement only&quot;))
+	    chew()
+	    navmode = &quot;manual&quot;
+	    key = IHEOL
+	    break
+	if isprobe and akey != -1:
+	    # For probe launch, use pre-scanned value first time 
+	    key = akey
+	    akey = -1
+	else: 
+	    key = scan()
+
+	if key == IHEOL:
+	    proutn(_(&quot;Manual or automatic- &quot;))
+	    iprompt = True
+	    chew()
+	elif key == IHALPHA:
+            if isit(&quot;manual&quot;):
+		navmode = &quot;manual&quot;
+		key = scan()
+		break
+            elif isit(&quot;automatic&quot;):
+		navmode = &quot;automatic&quot;
+		key = scan()
+		break
+	    else:
+		huh()
+		chew()
+		return
+	else: # numeric 
+	    if isprobe:
+		prout(_(&quot;(Manual navigation assumed.)&quot;))
+	    else:
+		prout(_(&quot;(Manual movement assumed.)&quot;))
+	    navmode = &quot;manual&quot;
+	    break
+
+    if navmode == &quot;automatic&quot;:
+	while key == IHEOL:
+	    if isprobe:
+		proutn(_(&quot;Target quadrant or quadrant&amp;sector- &quot;))
+	    else:
+		proutn(_(&quot;Destination sector or quadrant&amp;sector- &quot;))
+	    chew()
+	    iprompt = True
+	    key = scan()
+
+	if key != IHREAL:
+	    huh()
+	    return
+	xi = aaitem
+	key = scan()
+	if key != IHREAL:
+	    huh()
+	    return
+	xj = aaitem
+	key = scan()
+	if key == IHREAL:
+	    # both quadrant and sector specified 
+	    xk = aaitem
+	    key = scan()
+	    if key != IHREAL:
+		huh()
+		return
+	    xl = aaitem
+
+	    irowq = xi + 0.5
+	    icolq = xj + 0.5
+	    incr.y = xk + 0.5
+	    incr.x = xl + 0.5
+	else:
+	    if isprobe:
+		# only quadrant specified -- go to center of dest quad 
+		irowq = xi + 0.5
+		icolq = xj + 0.5
+		incr.y = incr.x = 5
+	    else:
+		incr.y = xi + 0.5
+		incr.x = xj + 0.5
+	    itemp = &quot;normal&quot;
+	if not VALID_QUADRANT(icolq,irowq) or not VALID_SECTOR(incr.x,incr.y):
+	    huh()
+	    return
+	skip(1)
+	if not isprobe:
+	    if itemp &gt; &quot;curt&quot;:
+		if iprompt:
+		    prout(_(&quot;Helmsman Sulu- \&quot;Course locked in for Sector %s.\&quot;&quot;) % incr)
+	    else:
+		prout(_(&quot;Ensign Chekov- \&quot;Course laid in, Captain.\&quot;&quot;))
+	deltax = icolq - game.quadrant.y + 0.1*(incr.x-game.sector.y)
+	deltay = game.quadrant.x - irowq + 0.1*(game.sector.x-incr.y)
+    else: # manual 
+	while key == IHEOL:
+	    proutn(_(&quot;X and Y displacements- &quot;))
+	    chew()
+	    iprompt = True
+	    key = scan()
+	itemp = &quot;verbose&quot;
+	if key != IHREAL:
+	    huh()
+	    return
+	deltax = aaitem
+	key = scan()
+	if key != IHREAL:
+	    huh()
+	    return
+	deltay = aaitem
+    # Check for zero movement 
+    if deltax == 0 and deltay == 0:
+	chew()
+	return
+    if itemp == &quot;verbose&quot; and not isprobe:
+	skip(1)
+	prout(_(&quot;Helmsman Sulu- \&quot;Aye, Sir.\&quot;&quot;))
+    game.dist = math.sqrt(deltax*deltax + deltay*deltay)
+    game.direc = math.atan2(deltax, deltay)*1.90985932
+    if game.direc &lt; 0.0:
+	game.direc += 12.0
+    chew()
+    return
+
+def impulse():
+    # move under impulse power 
+    game.ididit = False
+    if damaged(DIMPULS):
+	chew()
+	skip(1)
+	prout(_(&quot;Engineer Scott- \&quot;The impulse engines are damaged, Sir.\&quot;&quot;))
+	return
+    if game.energy &gt; 30.0:
+	getcd(False, 0)
+	if game.direc == -1.0:
+	    return
+	power = 20.0 + 100.0*game.dist
+    else:
+	power = 30.0
+
+    if power &gt;= game.energy:
+	# Insufficient power for trip 
+	skip(1)
+	prout(_(&quot;First Officer Spock- \&quot;Captain, the impulse engines&quot;))
+	prout(_(&quot;require 20.0 units to engage, plus 100.0 units per&quot;))
+	if game.energy &gt; 30:
+	    proutn(_(&quot;quadrant.  We can go, therefore, a maximum of %d&quot;) %
+                     int(0.01 * (game.energy-20.0)-0.05))
+	    prout(_(&quot; quadrants.\&quot;&quot;))
+	else:
+	    prout(_(&quot;quadrant.  They are, therefore, useless.\&quot;&quot;))
+	chew()
+	return
+    # Make sure enough time is left for the trip 
+    game.optime = game.dist/0.095
+    if game.optime &gt;= game.state.remtime:
+	prout(_(&quot;First Officer Spock- \&quot;Captain, our speed under impulse&quot;))
+	prout(_(&quot;power is only 0.95 sectors per stardate. Are you sure&quot;))
+	proutn(_(&quot;we dare spend the time?\&quot; &quot;))
+	if ja() == False:
+	    return
+    # Activate impulse engines and pay the cost 
+    imove(False)
+    game.ididit = True
+    if game.alldone:
+	return
+    power = 20.0 + 100.0*game.dist
+    game.energy -= power
+    game.optime = game.dist/0.095
+    if game.energy &lt;= 0:
+	finish(FNRG)
+    return
+
+def warp(timewarp):
+    # move under warp drive 
+    blooey = False; twarp = False
+    if not timewarp: # Not WARPX entry 
+	game.ididit = False
+	if game.damage[DWARPEN] &gt; 10.0:
+	    chew()
+	    skip(1)
+	    prout(_(&quot;Engineer Scott- \&quot;The impulse engines are damaged, Sir.\&quot;&quot;))
+	    return
+	if damaged(DWARPEN) and game.warpfac &gt; 4.0:
+	    chew()
+	    skip(1)
+	    prout(_(&quot;Engineer Scott- \&quot;Sorry, Captain. Until this damage&quot;))
+	    prout(_(&quot;  is repaired, I can only give you warp 4.\&quot;&quot;))
+	    return
+			
+	# Read in course and distance 
+	getcd(False, 0)
+	if game.direc == -1.0:
+	    return
+
+	# Make sure starship has enough energy for the trip 
+	power = (game.dist+0.05)*game.warpfac*game.warpfac*game.warpfac*(game.shldup+1)
+	if power &gt;= game.energy:
+	    # Insufficient power for trip 
+	    game.ididit = False
+	    skip(1)
+	    prout(_(&quot;Engineering to bridge--&quot;))
+	    if not game.shldup or 0.5*power &gt; game.energy:
+		iwarp = math.pow((game.energy/(game.dist+0.05)), 0.333333333)
+		if iwarp &lt;= 0:
+		    prout(_(&quot;We can't do it, Captain. We don't have enough energy.&quot;))
+		else:
+		    proutn(_(&quot;We don't have enough energy, but we could do it at warp %d&quot;) % iwarp)
+		    if game.shldup:
+			prout(&quot;,&quot;)
+			prout(_(&quot;if you'll lower the shields.&quot;))
+		    else:
+			prout(&quot;.&quot;)
+	    else:
+		prout(_(&quot;We haven't the energy to go that far with the shields up.&quot;))
+	    return
+						
+	# Make sure enough time is left for the trip 
+	game.optime = 10.0*game.dist/game.wfacsq
+	if game.optime &gt;= 0.8*game.state.remtime:
+	    skip(1)
+	    prout(_(&quot;First Officer Spock- \&quot;Captain, I compute that such&quot;))
+	    proutn(_(&quot;  a trip would require approximately %2.0f&quot;) %
+		   (100.0*game.optime/game.state.remtime))
+	    prout(_(&quot; percent of our&quot;))
+	    proutn(_(&quot;  remaining time.  Are you sure this is wise?\&quot; &quot;))
+	    if ja() == False:
+		game.ididit = False
+		game.optime=0 
+		return
+    # Entry WARPX 
+    if game.warpfac &gt; 6.0:
+	# Decide if engine damage will occur 
+	prob = game.dist*(6.0-game.warpfac)*(6.0-game.warpfac)/66.666666666
+	if prob &gt; Rand():
+	    blooey = True
+	    game.dist = Rand()*game.dist
+	# Decide if time warp will occur 
+	if 0.5*game.dist*math.pow(7.0,game.warpfac-10.0) &gt; Rand():
+	    twarp = True
+	if idebug and game.warpfac==10 and not twarp:
+	    blooey = False
+	    proutn(&quot;=== Force time warp? &quot;)
+	    if ja() == True:
+		twarp = True
+	if blooey or twarp:
+	    # If time warp or engine damage, check path 
+	    # If it is obstructed, don't do warp or damage 
+	    angle = ((15.0-game.direc)*0.5235998)
+	    deltax = -math.sin(angle)
+	    deltay = math.cos(angle)
+	    if math.fabs(deltax) &gt; math.fabs(deltay):
+		bigger = math.fabs(deltax)
+	    else:
+		bigger = math.fabs(deltay)
+			
+	    deltax /= bigger
+	    deltay /= bigger
+	    n = 10.0 * game.dist * bigger +0.5
+	    x = game.sector.x
+	    y = game.sector.y
+	    for l in range(1, n+1):
+		x += deltax
+		ix = x + 0.5
+		y += deltay
+		iy = y +0.5
+		if not VALID_SECTOR(ix, iy):
+		    break
+		if game.quad[ix][iy] != IHDOT:
+		    blooey = False
+		    twarp = False
+				
+
+    # Activate Warp Engines and pay the cost 
+    imove(False)
+    if game.alldone:
+	return
+    game.energy -= game.dist*game.warpfac*game.warpfac*game.warpfac*(game.shldup+1)
+    if game.energy &lt;= 0:
+	finish(FNRG)
+    game.optime = 10.0*game.dist/game.wfacsq
+    if twarp:
+	timwrp()
+    if blooey:
+	game.damage[DWARPEN] = game.damfac*(3.0*Rand()+1.0)
+	skip(1)
+	prout(_(&quot;Engineering to bridge--&quot;))
+	prout(_(&quot;  Scott here.  The warp engines are damaged.&quot;))
+	prout(_(&quot;  We'll have to reduce speed to warp 4.&quot;))
+    game.ididit = True
+    return
+
+def setwarp():
+    # change the warp factor 	
+    while True:
+        key=scan()
+        if key != IHEOL:
+            break
+	chew()
+	proutn(_(&quot;Warp factor- &quot;))
+    chew()
+    if key != IHREAL:
+	huh()
+	return
+    if game.damage[DWARPEN] &gt; 10.0:
+	prout(_(&quot;Warp engines inoperative.&quot;))
+	return
+    if damaged(DWARPEN) and aaitem &gt; 4.0:
+	prout(_(&quot;Engineer Scott- \&quot;I'm doing my best, Captain,&quot;))
+	prout(_(&quot;  but right now we can only go warp 4.\&quot;&quot;))
+	return
+    if aaitem &gt; 10.0:
+	prout(_(&quot;Helmsman Sulu- \&quot;Our top speed is warp 10, Captain.\&quot;&quot;))
+	return
+    if aaitem &lt; 1.0:
+	prout(_(&quot;Helmsman Sulu- \&quot;We can't go below warp 1, Captain.\&quot;&quot;))
+	return
+    oldfac = game.warpfac
+    game.warpfac = aaitem
+    game.wfacsq=game.warpfac*game.warpfac
+    if game.warpfac &lt;= oldfac or game.warpfac &lt;= 6.0:
+	prout(_(&quot;Helmsman Sulu- \&quot;Warp factor %d, Captain.\&quot;&quot;) %
+	       int(game.warpfac))
+	return
+    if game.warpfac &lt; 8.00:
+	prout(_(&quot;Engineer Scott- \&quot;Aye, but our maximum safe speed is warp 6.\&quot;&quot;))
+	return
+    if game.warpfac == 10.0:
+	prout(_(&quot;Engineer Scott- \&quot;Aye, Captain, we'll try it.\&quot;&quot;))
+	return
+    prout(_(&quot;Engineer Scott- \&quot;Aye, Captain, but our engines may not take it.\&quot;&quot;))
+    return
+
+def atover(igrab):
+    # cope with being tossed out of quadrant by supernova or yanked by beam 
+
+    chew()
+    # is captain on planet? 
+    if game.landed:
+	if damaged(DTRANSP):
+	    finish(FPNOVA)
+	    return
+	prout(_(&quot;Scotty rushes to the transporter controls.&quot;))
+	if game.shldup:
+	    prout(_(&quot;But with the shields up it's hopeless.&quot;))
+	    finish(FPNOVA)
+	prouts(_(&quot;His desperate attempt to rescue you . . .&quot;))
+	if Rand() &lt;= 0.5:
+	    prout(_(&quot;fails.&quot;))
+	    finish(FPNOVA)
+	    return
+	prout(_(&quot;SUCCEEDS!&quot;))
+	if game.imine:
+	    game.imine = False
+	    proutn(_(&quot;The crystals mined were &quot;))
+	    if Rand() &lt;= 0.25:
+		prout(_(&quot;lost.&quot;))
+	    else:
+		prout(_(&quot;saved.&quot;))
+		game.icrystl = True
+    if igrab:
+	return
+
+    # Check to see if captain in shuttle craft 
+    if game.icraft:
+	finish(FSTRACTOR)
+    if game.alldone:
+	return
+
+    # Inform captain of attempt to reach safety 
+    skip(1)
+    while True:
+	if game.justin:
+	    prouts(_(&quot;***RED ALERT!  RED ALERT!&quot;))
+	    skip(1)
+	    proutn(_(&quot;The &quot;))
+	    crmshp()
+	    prout(_(&quot; has stopped in a quadrant containing&quot;))
+	    prouts(_(&quot;   a supernova.&quot;))
+	    skip(2)
+	proutn(_(&quot;***Emergency automatic override attempts to hurl &quot;))
+	crmshp()
+	skip(1)
+	prout(_(&quot;safely out of quadrant.&quot;))
+	if not damaged(DRADIO):
+	    game.state.galaxy[game.quadrant.x][game.quadrant.y].charted = True
+	# Try to use warp engines 
+	if damaged(DWARPEN):
+	    skip(1)
+	    prout(_(&quot;Warp engines damaged.&quot;))
+	    finish(FSNOVAED)
+	    return
+	game.warpfac = 6.0+2.0*Rand()
+	game.wfacsq = game.warpfac * game.warpfac
+	prout(_(&quot;Warp factor set to %d&quot;) % int(game.warpfac))
+	power = 0.75*game.energy
+	game.dist = power/(game.warpfac*game.warpfac*game.warpfac*(game.shldup+1))
+	distreq = 1.4142+Rand()
+	if distreq &lt; game.dist:
+	    game.dist = distreq
+	game.optime = 10.0*game.dist/game.wfacsq
+	game.direc = 12.0*Rand()	# How dumb! 
+	game.justin = False
+	game.inorbit = False
+	warp(True)
+	if not game.justin:
+	    # This is bad news, we didn't leave quadrant. 
+	    if game.alldone:
+		return
+	    skip(1)
+	    prout(_(&quot;Insufficient energy to leave quadrant.&quot;))
+	    finish(FSNOVAED)
+	    return
+	# Repeat if another snova
+        if not game.state.galaxy[game.quadrant.x][game.quadrant.y].supernova:
+            break
+    if (game.state.remkl + game.state.remcom + game.state.nscrem)==0: 
+	finish(FWON) # Snova killed remaining enemy. 
+
+def timwrp():
+    # let's do the time warp again 
+    prout(_(&quot;***TIME WARP ENTERED.&quot;))
+    if game.state.snap and Rand() &lt; 0.5:
+	# Go back in time 
+	prout(_(&quot;You are traveling backwards in time %d stardates.&quot;) %
+	      int(game.state.date-game.snapsht.date))
+	game.state = game.snapsht
+	game.state.snap = False
+	if game.state.remcom:
+	    schedule(FTBEAM, expran(game.intime/game.state.remcom))
+	    schedule(FBATTAK, expran(0.3*game.intime))
+	schedule(FSNOVA, expran(0.5*game.intime))
+	# next snapshot will be sooner 
+	schedule(FSNAP, expran(0.25*game.state.remtime))
+				
+	if game.state.nscrem:
+	    schedule(FSCMOVE, 0.2777)	    
+	game.isatb = 0
+	unschedule(FCDBAS)
+	unschedule(FSCDBAS)
+	invalidate(game.battle)
+
+	# Make sure Galileo is consistant -- Snapshot may have been taken
+        # when on planet, which would give us two Galileos! 
+	gotit = False
+	for l in range(game.inplan):
+	    if game.state.planets[l].known == &quot;shuttle_down&quot;:
+		gotit = True
+		if game.iscraft == &quot;onship&quot; and game.ship==IHE:
+		    prout(_(&quot;Chekov-  \&quot;Security reports the Galileo has disappeared, Sir!&quot;))
+		    game.iscraft = &quot;offship&quot;
+	# Likewise, if in the original time the Galileo was abandoned, but
+	# was on ship earlier, it would have vanished -- let's restore it.
+	if game.iscraft == &quot;offship&quot; and not gotit and game.damage[DSHUTTL] &gt;= 0.0:
+	    prout(_(&quot;Checkov-  \&quot;Security reports the Galileo has reappeared in the dock!\&quot;&quot;))
+	    game.iscraft = &quot;onship&quot;
+	# 
+#	 * There used to be code to do the actual reconstrction here,
+#	 * but the starchart is now part of the snapshotted galaxy state.
+#	 
+	prout(_(&quot;Spock has reconstructed a correct star chart from memory&quot;))
+    else:
+	# Go forward in time 
+	game.optime = -0.5*game.intime*math.log(Rand())
+	prout(_(&quot;You are traveling forward in time %d stardates.&quot;) % int(game.optime))
+	# cheat to make sure no tractor beams occur during time warp 
+	postpone(FTBEAM, game.optime)
+	game.damage[DRADIO] += game.optime
+    newqad(False)
+    events()	# Stas Sergeev added this -- do pending events 
+
+def probe():
+    # launch deep-space probe 
+    # New code to launch a deep space probe 
+    if game.nprobes == 0:
+	chew()
+	skip(1)
+	if game.ship == IHE: 
+	    prout(_(&quot;Engineer Scott- \&quot;We have no more deep space probes, Sir.\&quot;&quot;))
+	else:
+	    prout(_(&quot;Ye Faerie Queene has no deep space probes.&quot;))
+	return
+    if damaged(DDSP):
+	chew()
+	skip(1)
+	prout(_(&quot;Engineer Scott- \&quot;The probe launcher is damaged, Sir.\&quot;&quot;))
+	return
+    if is_scheduled(FDSPROB):
+	chew()
+	skip(1)
+	if damaged(DRADIO) and game.condition != &quot;docked&quot;:
+	    prout(_(&quot;Spock-  \&quot;Records show the previous probe has not yet&quot;))
+	    prout(_(&quot;   reached its destination.\&quot;&quot;))
+	else:
+	    prout(_(&quot;Uhura- \&quot;The previous probe is still reporting data, Sir.\&quot;&quot;))
+	return
+    key = scan()
+
+    if key == IHEOL:
+	# slow mode, so let Kirk know how many probes there are left
+        if game.nprobes == 1:
+            prout(_(&quot;1 probe left.&quot;))
+        else:
+            prout(_(&quot;%d probes left&quot;) % game.nprobes)
+	proutn(_(&quot;Are you sure you want to fire a probe? &quot;))
+	if ja() == False:
+	    return
+
+    game.isarmed = False
+    if key == IHALPHA and citem == &quot;armed&quot;:
+	game.isarmed = True
+	key = scan()
+    elif key == IHEOL:
+	proutn(_(&quot;Arm NOVAMAX warhead? &quot;))
+	game.isarmed = ja()
+    getcd(True, key)
+    if game.direc == -1.0:
+	return
+    game.nprobes -= 1
+    angle = ((15.0 - game.direc) * 0.5235988)
+    game.probeinx = -math.sin(angle)
+    game.probeiny = math.cos(angle)
+    if math.fabs(game.probeinx) &gt; math.fabs(game.probeiny):
+	bigger = math.fabs(game.probeinx)
+    else:
+	bigger = math.fabs(game.probeiny)
+		
+    game.probeiny /= bigger
+    game.probeinx /= bigger
+    game.proben = 10.0*game.dist*bigger +0.5
+    game.probex = game.quadrant.x*QUADSIZE + game.sector.x - 1	# We will use better packing than original
+    game.probey = game.quadrant.y*QUADSIZE + game.sector.y - 1
+    game.probec = game.quadrant
+    schedule(FDSPROB, 0.01) # Time to move one sector
+    prout(_(&quot;Ensign Chekov-  \&quot;The deep space probe is launched, Captain.\&quot;&quot;))
+    game.ididit = True
+    return
+
+# Here's how the mayday code works:
+# 
+# First, the closest starbase is selected.  If there is a a starbase
+# in your own quadrant, you are in good shape.  This distance takes
+# quadrant distances into account only.
+#
+# A magic number is computed based on the distance which acts as the
+# probability that you will be rematerialized.  You get three tries.
+#
+# When it is determined that you should be able to be rematerialized
+# (i.e., when the probability thing mentioned above comes up
+# positive), you are put into that quadrant (anywhere).  Then, we try
+# to see if there is a spot adjacent to the star- base.  If not, you
+# can't be rematerialized!!!  Otherwise, it drops you there.  It only
+# tries five times to find a spot to drop you.  After that, it's your
+# problem.
+
+def mayday():
+    # yell for help from nearest starbase 
+    # There's more than one way to move in this game! 
+    line = 0
+
+    chew()
+    # Test for conditions which prevent calling for help 
+    if game.condition == &quot;docked&quot;:
+	prout(_(&quot;Lt. Uhura-  \&quot;But Captain, we're already docked.\&quot;&quot;))
+	return
+    if damaged(DRADIO):
+	prout(_(&quot;Subspace radio damaged.&quot;))
+	return
+    if game.state.rembase==0:
+	prout(_(&quot;Lt. Uhura-  \&quot;Captain, I'm not getting any response from Starbase.\&quot;&quot;))
+	return
+    if game.landed:
+	proutn(_(&quot;You must be aboard the &quot;))
+	crmshp()
+	prout(&quot;.&quot;)
+	return
+    # OK -- call for help from nearest starbase 
+    game.nhelp += 1
+    if game.base.x!=0:
+	# There's one in this quadrant 
+	ddist = distance(game.base, game.sector)
+    else:
+	ddist = FOREVER
+	for m in range(1, game.state.rembase+1):
+	    xdist = QUADSIZE * distance(game.state.baseq[m], game.quadrant)
+	    if xdist &lt; ddist:
+		ddist = xdist
+		line = m
+	# Since starbase not in quadrant, set up new quadrant 
+	game.quadrant = game.state.baseq[line]
+	newqad(True)
+    # dematerialize starship 
+    game.quad[game.sector.x][game.sector.y]=IHDOT
+    proutn(_(&quot;Starbase in Quadrant %s responds--&quot;) % game.quadrant)
+    crmshp()
+    prout(_(&quot; dematerializes.&quot;))
+    game.sector.x=0
+    for m in range(1, 5+1):
+	ix = game.base.x+3.0*Rand()-1
+	iy = game.base.y+3.0*Rand()-1
+	if VALID_SECTOR(ix,iy) and game.quad[ix][iy]==IHDOT:
+	    # found one -- finish up 
+	    game.sector.x=ix
+	    game.sector.y=iy
+	    break
+    if not is_valid(game.sector):
+	prout(_(&quot;You have been lost in space...&quot;))
+	finish(FMATERIALIZE)
+	return
+    # Give starbase three chances to rematerialize starship 
+    probf = math.pow((1.0 - math.pow(0.98,ddist)), 0.33333333)
+    for m in range(1, 3+1):
+	if m == 1: proutn(_(&quot;1st&quot;))
+	elif m == 2: proutn(_(&quot;2nd&quot;))
+	elif m == 3: proutn(_(&quot;3rd&quot;))
+	proutn(_(&quot; attempt to re-materialize &quot;))
+	crmshp()
+	game.quad[ix][iy]=(IHMATER0,IHMATER1,IHMATER2)[m-1]
+	textcolor(RED)
+	warble()
+	if Rand() &gt; probf:
+	    break
+	prout(_(&quot;fails.&quot;))
+	curses.delay_output(500)
+	textcolor(DEFAULT)
+    if m &gt; 3:
+	game.quad[ix][iy]=IHQUEST
+	game.alive = False
+	drawmaps(1)
+	setwnd(message_window)
+	finish(FMATERIALIZE)
+	return
+    game.quad[ix][iy]=game.ship
+    textcolor(GREEN)
+    prout(_(&quot;succeeds.&quot;))
+    textcolor(DEFAULT)
+    dock(False)
+    skip(1)
+    prout(_(&quot;Lt. Uhura-  \&quot;Captain, we made it!\&quot;&quot;))
+
+# Abandon Ship (the BSD-Trek description)
+# 
+# The ship is abandoned.  If your current ship is the Faire
+# Queene, or if your shuttlecraft is dead, you're out of
+# luck.  You need the shuttlecraft in order for the captain
+# (that's you!!) to escape.
+# 
+# Your crew can beam to an inhabited starsystem in the
+# quadrant, if there is one and if the transporter is working.
+# If there is no inhabited starsystem, or if the transporter
+# is out, they are left to die in outer space.
+# 
+# If there are no starbases left, you are captured by the
+# Klingons, who torture you mercilessly.  However, if there
+# is at least one starbase, you are returned to the
+# Federation in a prisoner of war exchange.  Of course, this
+# can't happen unless you have taken some prisoners.
+
+def abandon():
+    # abandon ship 
+    chew()
+    if game.condition==&quot;docked&quot;:
+	if game.ship!=IHE:
+	    prout(_(&quot;You cannot abandon Ye Faerie Queene.&quot;))
+	    return
+    else:
+	# Must take shuttle craft to exit 
+	if game.damage[DSHUTTL]==-1:
+	    prout(_(&quot;Ye Faerie Queene has no shuttle craft.&quot;))
+	    return
+	if game.damage[DSHUTTL]&lt;0:
+	    prout(_(&quot;Shuttle craft now serving Big Macs.&quot;))
+	    return
+	if game.damage[DSHUTTL]&gt;0:
+	    prout(_(&quot;Shuttle craft damaged.&quot;))
+	    return
+	if game.landed:
+	    prout(_(&quot;You must be aboard the ship.&quot;))
+	    return
+	if game.iscraft != &quot;onship&quot;:
+	    prout(_(&quot;Shuttle craft not currently available.&quot;))
+	    return
+	# Print abandon ship messages 
+	skip(1)
+	prouts(_(&quot;***ABANDON SHIP!  ABANDON SHIP!&quot;))
+	skip(1)
+	prouts(_(&quot;***ALL HANDS ABANDON SHIP!&quot;))
+	skip(2)
+	prout(_(&quot;Captain and crew escape in shuttle craft.&quot;))
+	if game.state.rembase==0:
+	    # Oops! no place to go... 
+	    finish(FABANDN)
+	    return
+	q = game.state.galaxy[game.quadrant.x][game.quadrant.y]
+	# Dispose of crew 
+	if not (game.options &amp; OPTION_WORLDS) and not damaged(DTRANSP):
+	    prout(_(&quot;Remainder of ship's complement beam down&quot;))
+	    prout(_(&quot;to nearest habitable planet.&quot;))
+	elif q.planet != NOPLANET and not damaged(DTRANSP):
+	    prout(_(&quot;Remainder of ship's complement beam down to %s.&quot;) %
+		    q.planet)
+	else:
+	    prout(_(&quot;Entire crew of %d left to die in outer space.&quot;) %
+		    game.state.crew)
+	    game.casual += game.state.crew
+	    game.abandoned += game.state.crew
+
+	# If at least one base left, give 'em the Faerie Queene 
+	skip(1)
+	game.icrystl = False # crystals are lost 
+	game.nprobes = 0 # No probes 
+	prout(_(&quot;You are captured by Klingons and released to&quot;))
+	prout(_(&quot;the Federation in a prisoner-of-war exchange.&quot;))
+	nb = Rand()*game.state.rembase+1
+	# Set up quadrant and position FQ adjacient to base 
+	if not same(game.quadrant, game.state.baseq[nb]):
+	    game.quadrant = game.state.baseq[nb]
+	    game.sector.x = game.sector.y = 5
+	    newqad(True)
+	while True:
+	    # position next to base by trial and error 
+	    game.quad[game.sector.x][game.sector.y] = IHDOT
+	    for l in range(1, QUADSIZE+1):
+		game.sector.x = 3.0*Rand() - 1.0 + game.base.x
+		game.sector.y = 3.0*Rand() - 1.0 + game.base.y
+		if VALID_SECTOR(game.sector.x, game.sector.y) and \
+                       game.quad[game.sector.x][game.sector.y] == IHDOT:
+                    break
+	    if l &lt; QUADSIZE+1:
+		break # found a spot 
+	    game.sector.x=QUADSIZE/2
+	    game.sector.y=QUADSIZE/2
+	    newqad(True)
+    # Get new commission 
+    game.quad[game.sector.x][game.sector.y] = game.ship = IHF
+    game.state.crew = FULLCREW
+    prout(_(&quot;Starfleet puts you in command of another ship,&quot;))
+    prout(_(&quot;the Faerie Queene, which is antiquated but,&quot;))
+    prout(_(&quot;still useable.&quot;))
+    if game.icrystl:
+	prout(_(&quot;The dilithium crystals have been moved.&quot;))
+    game.imine = False
+    game.iscraft = &quot;offship&quot; # Galileo disappears 
+    # Resupply ship 
+    game.condition=&quot;docked&quot;
+    for l in range(0, NDEVICES): 
+	game.damage[l] = 0.0
+    game.damage[DSHUTTL] = -1
+    game.energy = game.inenrg = 3000.0
+    game.shield = game.inshld = 1250.0
+    game.torps = game.intorps = 6
+    game.lsupres=game.inlsr=3.0
+    game.shldup=False
+    game.warpfac=5.0
+    game.wfacsq=25.0
+    return


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000129.html">[Sst-commit-watch] r662 - trunk/src
</A></li>
	<LI>Next message: <A HREF="000131.html">[Sst-commit-watch] r664 - trunk/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#130">[ date ]</a>
              <a href="thread.html#130">[ thread ]</a>
              <a href="subject.html#130">[ subject ]</a>
              <a href="author.html#130">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/sst-commit-watch">More information about the Sst-commit-watch
mailing list</a><br>
</body></html>
